
= Installation

== Prerequisites

Since the Orchestrator plugin for {product_rhdh_name} relies on Serverless Workflow, it requires two Operators to provide the primitives it relies on:

* OpenShift Serverless Operator
* OpenShift Serverless Logic Operator

These Operators provide the necessary *Knative* and *SonataFlow* https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/[Custom Resources^] that Orchestrator uses to facilitate the execution of custom workflows.

== Install the Serverless and Serverless Workflow Operators

To save time and ensure that the correct Operator versions are used, the Operators have been pre-installed in your cluster.

Confirm that both Operators are installed by visiting the https://console-openshift-console.{openshift_cluster_ingress_domain}/k8s/all-namespaces/operators.coreos.com\~v1alpha1\~ClusterServiceVersion[Installed Operators section^] of the OpenShift Web Console.

image:orchestrator-overview/install-operators.png[]

WARNING: If either Operator is missing, use Operator Hub to install the stable release with *Automatic Approval* enabled. Orchestrator requires these Operators to function.

== Add the Orchestrator Plugins to {product_rhdh_name}

Similar to the Operators, your environment has been pre-configured with the necessary dynamic plugins. 

NOTE: Module 2 provides an in-depth overview of {product_rhdh_name}'s dynamic plugins feature. Visit that module if you'd like a deep-dive on deployment and configuration for {product_rhdh_name}.

Verify that the dynamic plugins have been configured correctly:

. Visit the https://console-openshift-console.{openshift_cluster_ingress_domain}/k8s/ns/{ns_tssc_rhdh}/core~v1~ConfigMap[ConfigMaps screen^] in the *{ns_tssc_rhdh}* project.
. Select and view the YAML for the *backstage-dynamic-plugins-developer-hub* ConfigMap.
. Verify that the following plugins are listed in the `plugins` array:
  * @redhat/backstage-plugin-orchestrator
  * @redhat/backstage-plugin-orchestrator-backend-dynamic
  * @redhat/backstage-plugin-scaffolder-backend-module-orchestrator-dynamic
  * @redhat/backstage-plugin-orchestrator-form-widgets
. Inspect the `@redhat/backstage-plugin-orchestrator-backend-dynamic` - note that it has an additional dependencies property:
+
[source,yaml,subs=attributes+]
----
dependencies:
  - ref: sonataflow
----
. Inspect the *pluginConfig* associated with the `@redhat/backstage-plugin-scaffolder-backend-module-orchestrator-dynamic`. Notice that it specifies a `dataIndexService.url` property? This is the URL to a component of the SonataFlow Platform deployed in the same namespace as {product_rhdh_name}.
+
[source,yaml,subs=attributes+]
----
pluginConfig:
    orchestrator:
      dataIndexService:
        url: http://sonataflow-platform-data-index-service
----

So, why are these additional keys provided to the plugins?  In the case of `dependencies.ref`, it tells the {product_rhdh_name} Operator to provision the SonataFlow components, specifically a *SonataFlowPlatform* CR. The `dataIndexService.url` instructs the plugin to fetch available Workflows from the SonataFlowPlatform deployed in the same namespace as {product_rhdh_name} - you can opt to host and install the SonataFlowPlatform elsewhere if required.

== Verify the SonataFlowPlatform

You've confirmed that the Orchestrator plugins are configured correctly - now you'll confirm that the *SonataFlowPlatform* was created and the Pods are healthy.

. Return to the https://console-openshift-console.{openshift_cluster_ingress_domain}/topology/ns/{ns_tssc_rhdh}?view=graph[Topology View^] for the *{ns_tssc_rhdh}* namespace.
. You should see the *SonataFlowPlatform* (or *SFP* for short) - click the three dots next to its name and select *Edit SonataFlowPlatform* to view the CR created as a result of the `dependencies.ref` you saw earlier.
+
image::orchestrator-overview/sonataflow-platform-topology.png[]
. Confirm that `ownerReferences` in the *YAML* view shows that the {product_rhdh_name} instance is managing this SonataFlowPlatform.
. Additionally, you should notice that and `spec.services` is connecting SonataFlow to the {product_rhdh_name} PostgreSQL database - this is to manage and track workflow state.
+
image:orchestrator-overview/sonataflow-db-connection.png[]

// TODO add note about Service URL to link back to the plugin config

== Conclusion

Now that you're familiar with the installation and configuration of the Orchestrator plugins, Operators, and backing *SonataFlowPlatform*, it's time to learn about building and managing workflows.