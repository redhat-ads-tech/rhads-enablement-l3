== Configure the Argo CD Integration

The Argo CD plugin enables {product_rhdh_name} to display deployment status and continuous delivery information directly within the Software Catalog. This integration provides real-time visibility into application deployments managed by Argo CD.

* Display deployment status information in the Software Catalog
* Show application health and sync status from Argo CD
* Provide direct links to Argo CD application views
* Enable developers to monitor their application deployments without leaving the developer portal

Configuring the integration requires:

. Creating a dedicated readonly user account in Argo CD for secure API access
. Storing Argo CD credentials in a Secret and loading it into the {product_rhdh_name} pod
. Adding the Argo CD dynamic plugin to your {product_rhdh_name} plugin configuration
. Configuring entity annotations to link entities with https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/#applications[Argo CD Applications^]

== Create the Argo CD Service Account and Credentials

To facilitate secure communication between {product_rhdh_name} and Argo CD, you should create a dedicated readonly user account. It's possible to use the existing *admin* user account, however using the principle of least privilege is the best practice.

Your cluster has been pre-configured with an Argo CD instance that's managed by {product_gitops_name}. You'll update this instance to support the integration between it and {product_rhdh_name}.

=== Create a Readonly Argo CD User

. Log in to the {openshift_console_url}[OpenShift Web Console^] using the following credentials:
  * Username: `{openshift_admin_user}`
  * Password: `{openshift_admin_password}`
. Navigate to *Operators > Installed Operators* and search for "gitops" to find the {product_gitops_name} operator.
. Select the operator then the *Argo CD* tab.
+
image::setup-rhdh/argocd-operator.png[]
. Select the *{ns_tssc_gitops}* instance, and then *Actions > Edit Argo CD*.
. Add this line to the `extraConfig` section to add a *{m2_argocd_user}* user:
+
[source,yaml,role=execute,subs=attributes+]
----
accounts.developer-hub: 'apiKey, login'
----
. Edit the `rbac.policy` section to grant readonly permissions to the new user:
+
[source,yaml,role=execute,subs=attributes+]
----
policy: |
  g, system:cluster-admins, role:admin
  g, cluster-admins, role:admin
  g, developer-hub, role:readonly
----
. The resulting configuration will resemble the following screenshot.
+
image::setup-rhdh/argocd-operator-config.png[]
. Scroll down and click *Save*.

The operator will update the necessary Argo CD ConfigMaps to enable the new *{m2_argocd_user}* user account. 

=== Set the Readonly Argo CD User's Password

. Navigate to *Workloads > Secrets* in the *{ns_tssc_gitops}* project.
. Select the `argocd-secret` Secret, and use the *Actions* dropdown to select *Edit Secret*.
. Scroll down and click *Add key/value*.
. Supply the following *Key*:
+
[source,yaml,role=execute,subs=attributes+]
----
accounts.{m2_argocd_user}.password
----
. Supply the following *Value*:
+
[source,yaml,role=execute,subs=attributes+]
----
{m2_argocd_passhash}
----
+
image::setup-rhdh/argocd-secret.png[]
. Click *Save*.

The new password is `{m2_argocd_pass}`, but Argo CD expects a hash and salt generated using bcrypt. The hash and salt provided above were generated using htpasswd like so: `htpasswd -bnBC 10 "" '{m2_argocd_pass}'`.

=== Verify the Argo CD User Account is Active

. Visit https://console-openshift-console.{openshift_cluster_ingress_domain}/k8s/ns/tssc-gitops/route.openshift.io{tilde}v1{tilde}Route[*Networking > Routes* in the {ns_tssc_gitops}^] namespace.
. Click the link in the *Location* column to access Argo CD.
. *Do not click* the *Log in via OpenShift* button.
. Login using the username `{m2_argocd_user}` and password `{m2_argocd_pass}` - an empty application list will be displayed.

image::setup-rhdh/argocd-dashboard.png[]

[NOTE]
====
If you can't login, review the Argo CD ConfigMap and Secret changes you made for accuracy.
====

== Update the {product_rhdh_name} Configuration

Now that Argo CD is configured with a readonly user, you'll update the {product_rhdh_name} configuration to enable the Argo CD integration. The procedure is similar to the previous plugins you added, so you're probably becoming familiar with it by now.

=== Create a Secret for Argo CD Credentials

Create a Secret in your {product_rhdh_name} namespace to store the *{m2_argocd_user}* Argo CD credentials:

. Navigate to *Workloads > Secrets*.
. Ensure that the `{m2_rhdh_project}` project is selected.
. Click *Create > From YAML*
. Replace the content in the YAML editor with the following:
+
[source,yaml,role=execute,subs=attributes+]
----
apiVersion: v1
kind: Secret
metadata:
  name: argocd-secrets
  namespace: {m2_rhdh_project}
type: Opaque
stringData:
  # Warning: Remove trailing slashes or the plugin will throw "method not allowed" errors
  ARGOCD_URL: https://{ns_tssc_gitops}-server-{ns_tssc_gitops}.{openshift_cluster_ingress_domain}
  ARGOCD_USERNAME: {m2_argocd_user}
  ARGOCD_PASSWORD: {m2_argocd_pass}
----
. Click *Create*.

=== Add Argo CD Secrets to the Backstage CR

Update your Backstage CR to include the Argo CD secret:

. Navigate to your https://console-openshift-console.{openshift_cluster_ingress_domain}/k8s/ns/{m2_rhdh_project}/clusterserviceversions/rhdh-operator.v1.7.1/rhdh.redhat.com{tilde}v1alpha3{tilde}Backstage/rhdh[Backstage CR in the OpenShift Web Console^] and switch to the *YAML* view.
. Update the `extraEnvs.secrets` section to reference the *argocd-secrets* Secret you created:
+
[source,yaml,role=execute,subs=attributes+]
----
extraEnvs:
  secrets:
    - name: {m2_keycloak_secret_name}
    - name: gitlab-secrets
    # Inject the ARGOCD_URL, ARGOCD_USERNAME, 
    # and ARGOCD_PASSWORD into the pod as environment variables
    - name: argocd-secrets
----
. Click *Save*.

=== Enable the Argo CD Dynamic Plugin

Enable the Argo CD plugin by updating your *{m2_rhdh_plugins_cm_name}* ConfigMap:

. Navigate to *Workloads > ConfigMaps* and click on `{m2_rhdh_plugins_cm_name}`.
. Click *Edit ConfigMap*.
. Update the `dynamic-plugins.yaml` content to include the Argo CD plugins:
+
[source,yaml,role=execute,subs=attributes+]
----
- package: ./dynamic-plugins/dist/roadiehq-backstage-plugin-argo-cd-backend-dynamic
  disabled: false
- package: ./dynamic-plugins/dist/backstage-community-plugin-redhat-argocd
  disabled: false
----
+
[NOTE]
====
Verify that your indentation is correct by aligning it with the existing plugins.
====
. Click *Save*.

=== Configure the Argo CD Plugin 

Update your *app-config.yaml* to include Argo CD integration configuration:

. Navigate to *Workloads > ConfigMaps* and click on `{m2_rhdh_cm_name}`.
. Click *Edit ConfigMap*.
. Add the following `argocd` configuration at the root level of the *app-config.yaml*:
+
[source,yaml,role=execute,subs=attributes+]
----
argocd:
  appLocatorMethods:
    - type: config
      instances:
        - name: argocd
          url: ${ARGOCD_URL}
          username: ${ARGOCD_USERNAME}
          password: ${ARGOCD_PASSWORD}
----
+
[NOTE]
====
The `argocd` key should be at the same indentation level as the `catalog` and `integrations` keys in the *app-config.yaml*.
====
. Click *Save* to update the *app-config.yaml*.

Wait for the new Backstage pod to start, and check the *backstage-backend* logs for the Argo CD plugin initializing messages.

image::setup-rhdh/argocd-plugin-logs.png[]

== Verify Argo CD Integration

=== Configure and Verify Entity Annotations and Application Labels

For entities to display Argo CD information, they must include the appropriate annotation linking them to their corresponding Argo CD applications.

Recall that your environment has been pre-configured with a repository that contains a sample *catalog-info.yaml* in GitLab - https://gitlab-gitlab.{openshift_cluster_ingress_domain}/rhdh/module-2-assets/-/tree/main/discovery-example[module-2-assets/discovery-example^].

[NOTE]
====
Normally the *catalog-info.yaml* file will live alongside source code, or in a dedicated repository for catalog files. This module places it in the same repository as the deployment manifests for convenience.
====

In this case you can see that the https://gitlab-gitlab.{openshift_cluster_ingress_domain}/rhdh/module-2-assets/-/blob/main/discovery-example/catalog-info.yaml?ref_type=heads[*argocd/app-selector* annotation^] is set on the Component. This tells the Argo CD plugin for {product_rhdh_name} to query the configured Argo CD instance for Applications with a label matching that selector.

=== Create a Namespace

In this section you'll create an Argo CD Application. This Application will manage resources in a specific namespace. You'll pre-create this namespace with a specific label that ensures the *tssc-gitops* Argo CD instance can manage resources inside that namespace. The OpenShift GitOps operator detects this label and updates the Argo CD permissions accordingly.

. Visit the OpenShift Web Console and ensure you're logged in as the *admin* user.
. Click the plus icon in the top-right corner and select *Import YAML*.
. Paste the following to create the namespace:
+
[source,yaml,role=execute,subs=attributes+]
----
kind: Namespace
apiVersion: v1
metadata:
  name: httpsink
  labels:
    # Provide the tssc-gitops instance with permission to
    # manage kubernetes resources in this namespace
    argocd.argoproj.io/managed-by: tssc-gitops
----
. Click *Create*.
. Confirm the namespace is managed by https://tssc-gitops-server-tssc-gitops.{openshift_cluster_ingress_domain}/settings/clusters[viewing the clusters screen in Argo CD^], then selecting the *in-cluster* item. Login as:
  * Username: `{m2_argocd_user}`
  * Password: `{m2_argocd_pass}`
. Your new *httpsink* namespace should be listed in the *Namespaces* field.
+
image::setup-rhdh/argocd-cluster-details.png[]

=== Create an Argo CD Application

Earlier, you logged into Argo CD and confirmed that no Applications existed; it's time to create one.

. Visit the OpenShift Web Console and ensure you're logged in as the *admin* user.
. Click the plus icon in the top-right corner and select *Import YAML* to create the Application using this YAML.
+
[source,yaml,role=execute,subs=attributes+]
----
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: httpsink
  namespace: tssc-gitops
  labels:
    app.kubernetes.io/name: httpsink
    backstage.io/app: httpsink
spec:
  project: default
  source:
    repoURL: https://gitlab-gitlab.{openshift_cluster_ingress_domain}/rhdh/module-2-assets.git
    targetRevision: HEAD
    path: argocd-example/k8s
  destination:
    name: in-cluster
    namespace: httpsink
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
----

The Application you created is a simple example, but notably it has a `app.kubernetes.io/name: httpsink` label. Recall that the Argo CD plugin for {product_rhdh_name} uses a selector to query information from Argo CD for a given Backstage Entity - this is the label your Component uses as the selector when querying Argo CD for deployment information.

=== View the Application in Argo CD and Developer Hub

First, perform a sanity check by viewing your new application in the Argo CD dashboard.

. Visit the https://{ns_tssc_gitops}-server-{ns_tssc_gitops}.{openshift_cluster_ingress_domain}/[*{ns_tssc_gitops}* Argo CD dashboard^].
. Login as:
    * Username: `{m2_argocd_user}`
    * Password: `{m2_argocd_pass}`
. Confirm that the application named *httpsink* is listed and marked as *Healthy* and *Synced*.
+
image::setup-rhdh/argocd-application.png[]

. Next, return to https://backstage-{m2_rhdh_instance}-{m2_rhdh_project}.{openshift_cluster_ingress_domain}[{product_rhdh_name}^].
. Login as:
    * Username: `{rhdh_user}`
    * Password: `{rhdh_user_password}`
. Visit the *Catalog* by clicking the link on the left menu, ensure *Kind* is set to *Component* and search for `httpsink`.
+
image::setup-rhdh/argocd-httpsink-search.png[]
. Select the *HTTP Sink Application* from the list, then view the *CD* tab for the Component.
+
image::setup-rhdh/argocd-httpsink-cd.png[]
. Click on the listed application to view more information on the managed Kubernetes resources.
+
image::setup-rhdh/argocd-httpsink-app-info.png[]

= Conclusion

Nice work! Developers can now view the continuous delivery status of their applications directly in {product_rhdh_name}. In this instance, just one environment's information is shown, but the application could be deployed in multiple environments. A card for each environment would be listed in the Argo CD tab.
